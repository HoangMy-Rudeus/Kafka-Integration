# C2 - Component Architecture Description

## Component-Level Architecture

### Service Component Breakdown

#### Order Service Component
```mermaid
graph TB
    subgraph "Order Service"
        OC[OrdersController]
        OS[OrderService]
        KP[KafkaProducerService]
        ODC[OrderDbContext]
        
        subgraph "Models"
            ORDER_MODEL[Order]
            ORDER_ITEM[OrderItem]
        end
        
        subgraph "Events"
            ORDER_CREATED[OrderCreatedEvent]
        end
    end
    
    OC --> OS
    OS --> KP
    OS --> ODC
    OS --> ORDER_MODEL
    ORDER_MODEL --> ORDER_ITEM
    KP --> ORDER_CREATED
    
    style OC fill:#e1f5fe
    style OS fill:#e1f5fe
    style KP fill:#f3e5f5
    style ODC fill:#e0f2f1
```

**Responsibilities:**
- REST API endpoint management
- Order business logic processing
- Event publishing to Kafka
- Order data persistence
- Request/response handling and validation

**Key Interfaces:**
- `IOrderService` - Business logic abstraction
- `IKafkaProducer<BaseEvent>` - Event publishing interface
- REST endpoints for order operations

#### Inventory Service Component
```mermaid
graph TB
    subgraph "Inventory Service"
        IC[InventoryController]
        IS[InventoryService]
        KC[KafkaConsumerService]
        OEH[OrderEventHandler]
        IDC[InventoryDbContext]
        
        subgraph "Models"
            INVENTORY[Inventory]
        end
        
        subgraph "Events"
            INVENTORY_RESERVED[InventoryReservedEvent]
        end
    end
    
    IC --> IS
    IS --> IDC
    KC --> OEH
    OEH --> IS
    IS --> INVENTORY_RESERVED
    IS --> INVENTORY
    
    style IC fill:#e8f5e8
    style IS fill:#e8f5e8
    style KC fill:#f3e5f5
    style OEH fill:#f3e5f5
    style IDC fill:#e0f2f1
```

**Responsibilities:**
- Inventory level management
- Order event consumption from Kafka
- Inventory reservation processing
- Inventory status reporting
- Stock level persistence

**Key Interfaces:**
- `IInventoryService` - Inventory operations
- `IKafkaConsumer<BaseEvent>` - Event consumption interface
- Background service for event processing

#### Notification Service Component
```mermaid
graph TB
    subgraph "Notification Service"
        NC[NotificationsController]
        NS[NotificationService]
        KC[KafkaConsumerService]
        EH[EventHandler]
        NDC[NotificationDbContext]
        
        subgraph "Models"
            NOTIFICATION[Notification]
        end
        
        subgraph "Event Handlers"
            ORDER_HANDLER[OrderCreatedHandler]
            INVENTORY_HANDLER[InventoryReservedHandler]
        end
    end
    
    NC --> NS
    NS --> NDC
    KC --> EH
    EH --> ORDER_HANDLER
    EH --> INVENTORY_HANDLER
    ORDER_HANDLER --> NS
    INVENTORY_HANDLER --> NS
    NS --> NOTIFICATION
    
    style NC fill:#fff3e0
    style NS fill:#fff3e0
    style KC fill:#f3e5f5
    style EH fill:#f3e5f5
    style NDC fill:#e0f2f1
```

**Responsibilities:**
- Customer notification management
- Multi-event consumption from Kafka
- Notification message generation
- Notification history persistence
- Test notification endpoints

### Shared Components

#### Shared Library Component
```mermaid
graph TB
    subgraph "KafkaMicroservices.Shared"
        subgraph "Events"
            BASE_EVENT[BaseEvent]
            ORDER_CREATED[OrderCreatedEvent]
            INVENTORY_RESERVED[InventoryReservedEvent]
        end
        
        subgraph "Models"
            ORDER[Order]
            ORDER_ITEM[OrderItem] 
            INVENTORY[Inventory]
            NOTIFICATION[Notification]
        end
        
        subgraph "Services"
            KAFKA_PRODUCER[IKafkaProducer]
            KAFKA_CONSUMER[IKafkaConsumer]
            MESSAGE_SERIALIZER[MessageSerializer]
        end
        
        subgraph "Configuration"
            KAFKA_SETTINGS[KafkaSettings]
            TOPICS[Topics]
        end
    end
    
    ORDER_CREATED --> BASE_EVENT
    INVENTORY_RESERVED --> BASE_EVENT
    ORDER --> ORDER_ITEM
    
    style BASE_EVENT fill:#f3e5f5
    style KAFKA_PRODUCER fill:#f3e5f5
    style KAFKA_CONSUMER fill:#f3e5f5
```

**Responsibilities:**
- Common data models across services
- Event schema definitions
- Kafka integration interfaces
- Message serialization/deserialization
- Shared configuration structures

### Component Interaction Patterns

#### Event Publishing Pattern
```mermaid
sequenceDiagram
    participant Controller
    participant Service
    participant KafkaProducer
    participant Kafka
    
    Controller->>Service: Business Operation
    Service->>Service: Process Business Logic
    Service->>KafkaProducer: ProduceAsync(event)
    KafkaProducer->>KafkaProducer: Serialize Event
    KafkaProducer->>Kafka: Publish to Topic
    Kafka-->>KafkaProducer: Acknowledgment
    KafkaProducer-->>Service: Completion
    Service-->>Controller: Result
```

#### Event Consumption Pattern
```mermaid
sequenceDiagram
    participant Kafka
    participant KafkaConsumer
    participant EventHandler
    participant Service
    participant Database
    
    Kafka->>KafkaConsumer: Event Message
    KafkaConsumer->>KafkaConsumer: Deserialize Event
    KafkaConsumer->>EventHandler: HandleEvent(event)
    EventHandler->>Service: ProcessEvent(event)
    Service->>Database: Persist Changes
    Database-->>Service: Confirmation
    Service-->>EventHandler: Completion
    EventHandler-->>KafkaConsumer: Success
```

### Data Flow Architecture

#### Service-Specific Data Stores
- **Order Service Database**: Orders, OrderItems tables
- **Inventory Service Database**: Inventory table with stock levels
- **Notification Service Database**: Notifications table with customer messages

#### Cross-Service Data Consistency
- **Event-Driven Consistency**: Changes propagated via Kafka events
- **No Direct Database Access**: Services only access their own data stores
- **Eventual Consistency**: Data synchronization through event processing

### Component Configuration

#### Environment Configuration
- **Service-Specific**: Each service has its own appsettings.json
- **Kafka Configuration**: Consistent broker settings across services
- **Database Connections**: Service-specific PostgreSQL connections
- **Docker Environment**: Container-specific environment variables

#### Dependency Injection Structure
- **Scoped Services**: Entity Framework DbContext and business services
- **Singleton Services**: Kafka producers/consumers and settings
- **Hosted Services**: Background event processors

### Monitoring and Health Components

#### Health Check Pattern
- **Service Health**: Individual service status endpoints
- **Dependency Health**: Database and Kafka connectivity checks
- **Aggregate Health**: Overall system health reporting

#### Logging Strategy
- **Structured Logging**: JSON format with correlation IDs
- **Service Identification**: Clear service boundaries in logs
- **Event Tracking**: Complete event flow visibility
